# GitHub Actions - Schema Validation Workflow
name: ğŸ” Database Schema Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'prisma/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'prisma/**'
  workflow_dispatch:

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  NEON_DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}

jobs:
  validate-schema:
    name: ğŸ—ï¸ Validate Database Schema
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: cardnexus
          POSTGRES_USER: cardnexus_user
          POSTGRES_PASSWORD: cardnexus_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: npm ci

    - name: ğŸ—ï¸ Setup Test Database
      env:
        DATABASE_URL: postgresql://cardnexus_user:cardnexus_password@localhost:5432/cardnexus?schema=public
      run: |
        npx prisma migrate deploy
        npx prisma generate

    - name: ğŸ” Validate Local Schema
      env:
        DATABASE_URL: postgresql://cardnexus_user:cardnexus_password@localhost:5432/cardnexus?schema=public
      run: |
        echo "ğŸ—ï¸ Checking local test database schema..."
        npx prisma migrate status

    - name: ğŸŒ Validate Neon Schema (if available)
      if: env.NEON_DATABASE_URL != ''
      env:
        DATABASE_URL: ${{ env.NEON_DATABASE_URL }}
      run: |
        echo "ğŸŒ Checking Neon production database schema..."
        npx prisma migrate status

    - name: âœ… Schema Validation Summary
      run: |
        echo "ğŸ‰ All database schemas validated successfully!"
        echo "âœ… Local test schema: OK"
        if [ -n "$NEON_DATABASE_URL" ]; then
          echo "âœ… Neon production schema: OK"
        else
          echo "âš ï¸ Neon validation skipped (no NEON_DATABASE_URL)"
        fi